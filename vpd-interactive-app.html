<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Control VPD Interactivo</title>
    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }
        
        body {
            font-family: 'Segoe UI', Arial, sans-serif;
            background: #f0f2f5;
            padding: 20px;
        }
        
        .app-container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 12px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.1);
            overflow: hidden;
        }
        
        .header {
            background: linear-gradient(135deg, #2c3e50 0%, #3498db 100%);
            color: white;
            padding: 20px;
            text-align: center;
        }
        
        .header h1 {
            font-size: 28px;
            margin-bottom: 10px;
        }
        
        /* Panel de control */
        .control-panel {
            background: #f8f9fa;
            padding: 20px;
            border-bottom: 2px solid #e9ecef;
        }
        
        .week-selector {
            display: flex;
            justify-content: center;
            gap: 15px;
            margin-bottom: 20px;
        }
        
        .week-btn {
            padding: 12px 30px;
            border: 2px solid #ddd;
            background: white;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            font-weight: bold;
            transition: all 0.3s;
            position: relative;
        }
        
        .week-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }
        
        .week-btn.active {
            background: #3498db;
            color: white;
            border-color: #3498db;
        }
        
        .week-btn.week1.active { background: #27ae60; border-color: #27ae60; }
        .week-btn.week2.active { background: #f39c12; border-color: #f39c12; }
        .week-btn.week3.active { background: #3498db; border-color: #3498db; }
        
        /* Información de objetivos */
        .target-info {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }
        
        .target-card {
            background: white;
            padding: 15px;
            border-radius: 8px;
            border: 2px solid #e9ecef;
        }
        
        .target-card h3 {
            font-size: 18px;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .target-values {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
        }
        
        .value-box {
            padding: 10px;
            background: #f8f9fa;
            border-radius: 6px;
            text-align: center;
        }
        
        .value-box .label {
            font-size: 12px;
            color: #666;
            margin-bottom: 5px;
        }
        
        .value-box .value {
            font-size: 20px;
            font-weight: bold;
            color: #2c3e50;
        }
        
        .value-box.optimal {
            background: #d4edda;
            border: 1px solid #c3e6cb;
        }
        
        /* Contenedor de tablas */
        .tables-container {
            padding: 20px;
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }
        
        .table-section {
            background: white;
            border: 2px solid #e9ecef;
            border-radius: 8px;
            overflow: hidden;
        }
        
        .table-header {
            padding: 15px;
            font-size: 18px;
            font-weight: bold;
            text-align: center;
        }
        
        .day-header {
            background: #fff3cd;
            color: #856404;
        }
        
        .night-header {
            background: #cce5ff;
            color: #004085;
        }
        
        /* Estilos de tabla */
        .vpd-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 12px;
        }
        
        .vpd-table th, .vpd-table td {
            padding: 6px;
            text-align: center;
            border: 1px solid #dee2e6;
        }
        
        .vpd-table th {
            background: #343a40;
            color: white;
            font-weight: bold;
            position: sticky;
            top: 0;
        }
        
        .temp-col {
            background: #495057;
            color: white;
            font-weight: bold;
            position: sticky;
            left: 0;
        }
        
        /* Clases dinámicas para VPD */
        .vpd-cell {
            position: relative;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .vpd-cell:hover {
            transform: scale(1.1);
            z-index: 10;
            box-shadow: 0 2px 8px rgba(0,0,0,0.2);
        }
        
        /* Colores base */
        .optimal { 
            font-weight: bold;
            color: white;
        }
        
        .acceptable {
            font-weight: normal;
        }
        
        .low {
            background: #f8d7da;
            color: #721c24;
        }
        
        .high {
            background: #f5c6cb;
            color: #721c24;
        }
        
        .very-high {
            background: #dc3545;
            color: white;
        }
        
        /* Marcadores de sensores */
        .sensor-marker {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 18px;
            height: 18px;
            border-radius: 50%;
            background: rgba(255,255,255,0.9);
            border: 2px solid #000;
            font-size: 10px;
            font-weight: bold;
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 20;
        }
        
        /* Leyenda adaptativa */
        .legend {
            margin: 20px;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 8px;
        }
        
        .legend-title {
            font-weight: bold;
            margin-bottom: 10px;
        }
        
        .legend-items {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
        }
        
        .legend-item {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .color-box {
            width: 24px;
            height: 24px;
            border-radius: 4px;
            border: 1px solid #999;
        }
        
        /* Responsive */
        @media (max-width: 1200px) {
            .tables-container {
                grid-template-columns: 1fr;
            }
        }
        
        @media (max-width: 768px) {
            .week-selector {
                flex-direction: column;
            }
            
            .target-info {
                grid-template-columns: 1fr;
            }
        }
        
        /* Animaciones */
        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); }
        }
        
        .optimal {
            animation: pulse 2s infinite;
        }
        
        /* Tooltip */
        .tooltip {
            position: absolute;
            background: #333;
            color: white;
            padding: 5px 10px;
            border-radius: 4px;
            font-size: 12px;
            pointer-events: none;
            z-index: 1000;
            opacity: 0;
            transition: opacity 0.3s;
        }
        
        .tooltip.show {
            opacity: 1;
        }
    </style>
</head>
<body>
    <div class="app-container">
        <div class="header">
            <h1>🌱 Control VPD Interactivo - Agricultura Vertical</h1>
            <p>Selecciona la semana de crecimiento para ver las zonas VPD óptimas</p>
        </div>
        
        <div class="control-panel">
            <div class="week-selector">
                <button class="week-btn week1" onclick="selectWeek(1)">
                    <span style="font-size: 24px;">🌱</span><br>
                    Semana 1<br>
                    <small>Establecimiento</small>
                </button>
                <button class="week-btn week2" onclick="selectWeek(2)">
                    <span style="font-size: 24px;">🌿</span><br>
                    Semana 2<br>
                    <small>Desarrollo</small>
                </button>
                <button class="week-btn week3 active" onclick="selectWeek(3)">
                    <span style="font-size: 24px;">🥬</span><br>
                    Semana 3<br>
                    <small>Producción</small>
                </button>
            </div>
            
            <!-- Alerta de situación actual -->
            <div style="background: #f8d7da; border: 2px solid #f5c6cb; border-radius: 8px; padding: 15px; margin: 20px 0;">
                <h4 style="color: #721c24; margin: 0 0 10px 0;">⚠️ Situación Actual Crítica - Noche</h4>
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px;">
                    <div style="text-align: center;">
                        <div style="font-size: 12px; color: #721c24;">Condiciones Actuales</div>
                        <div style="font-size: 18px; font-weight: bold; color: #a94442;">17-19°C / 74-80% HR</div>
                        <div style="font-size: 14px; color: #721c24;">VPD: 0.35-0.50 kPa</div>
                    </div>
                    <div style="text-align: center;">
                        <div style="font-size: 12px; color: #721c24;">Cambio Necesario</div>
                        <div style="font-size: 18px; font-weight: bold; color: #a94442;">+3-4°C / -12-16% HR</div>
                        <div style="font-size: 14px; color: #721c24;">Para VPD: 0.80-1.00 kPa</div>
                    </div>
                    <div style="text-align: center;">
                        <div style="font-size: 12px; color: #721c24;">Acción Inmediata</div>
                        <div style="font-size: 14px; font-weight: bold; color: #a94442;">Activar calefacción<br>+ Deshumidificadores 80%</div>
                    </div>
                </div>
            </div>
            
            <div class="target-info">
                <div class="target-card">
                    <h3><span id="week-icon">🥬</span> Objetivos <span id="week-name">Semana 3</span></h3>
                    <div class="target-values">
                        <div class="value-box optimal">
                            <div class="label">VPD Óptimo</div>
                            <div class="value" id="vpd-range">0.80-1.00</div>
                        </div>
                        <div class="value-box">
                            <div class="label">Enfoque</div>
                            <div class="value" id="week-focus">Máxima biomasa</div>
                        </div>
                    </div>
                </div>
                
                <div class="target-card">
                    <h3>☀️ Condiciones Día (con luz)</h3>
                    <div class="target-values">
                        <div class="value-box">
                            <div class="label">Temperatura</div>
                            <div class="value" id="day-temp">20-24°C</div>
                        </div>
                        <div class="value-box">
                            <div class="label">Humedad</div>
                            <div class="value" id="day-rh">60-75%</div>
                        </div>
                    </div>
                </div>
                
                <div class="target-card">
                    <h3>🌙 Condiciones Noche (sin luz)</h3>
                    <div class="target-values">
                        <div class="value-box">
                            <div class="label">Temperatura</div>
                            <div class="value" id="night-temp">20-21°C</div>
                        </div>
                        <div class="value-box">
                            <div class="label">Humedad</div>
                            <div class="value" id="night-rh">64-68%</div>
                        </div>
                    </div>
                    <div style="margin-top: 10px; padding: 10px; background: #d4edda; border-radius: 6px;">
                        <div style="font-size: 12px; color: #155724; text-align: center;">
                            <strong>VPD Objetivo Noche:</strong><br>
                            <span id="night-vpd" style="font-size: 16px;">0.80-1.00 kPa</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="tables-container">
            <!-- Tabla DÍA -->
            <div class="table-section">
                <div class="table-header day-header">☀️ PERÍODO DÍA (Con Luz) - 5:00 a 17:00</div>
                <table class="vpd-table" id="day-table">
                    <!-- Se genera dinámicamente -->
                </table>
            </div>
            
            <!-- Tabla NOCHE -->
            <div class="table-section">
                <div class="table-header night-header">🌙 PERÍODO NOCHE (Sin Luz) - 17:00 a 5:00</div>
                <table class="vpd-table" id="night-table">
                    <!-- Se genera dinámicamente -->
                </table>
            </div>
        </div>
        
        <div class="legend">
            <div class="legend-title">📊 Leyenda - <span id="legend-week">Semana 3</span></div>
            <div class="legend-items" id="legend-items">
                <!-- Se actualiza dinámicamente -->
            </div>
            
            <div style="margin-top: 20px; padding: 15px; background: #e8f8f5; border-radius: 8px; border: 1px solid #c3e6cb;">
                <h4 style="color: #155724; margin-top: 0;">💡 Protocolo Nocturno Crítico</h4>
                <p style="color: #155724; margin: 5px 0; font-size: 14px;">
                    <strong>Horario de transición:</strong><br>
                    • 16:30 - Iniciar pre-calentamiento (+1°C)<br>
                    • 17:00 - Luces OFF, acelerar calentamiento y deshumidificación<br>
                    • 18:00 - Alcanzar condiciones objetivo (21-22°C / 62-66% HR)<br>
                    • 18:00-04:30 - Mantener VPD 0.80-1.10 kPa<br>
                    • 04:30 - Iniciar enfriamiento gradual<br>
                    • 05:00 - Luces ON
                </p>
                <p style="color: #721c24; font-weight: bold; margin: 10px 0 0 0; font-size: 14px;">
                    ⚠️ NUNCA mantener VPD < 0.60 por más de 2 horas (riesgo de condensación y patógenos)
                </p>
            </div>
        </div>
    </div>
    
    <div class="tooltip" id="tooltip"></div>
    
    <script>
        // Configuración de semanas
        const weekConfigs = {
            1: {
                name: 'Semana 1',
                icon: '🌱',
                vpdRange: '1.00-1.05',
                focus: 'Establecimiento radicular',
                optimalMin: 1.00,
                optimalMax: 1.05,
                acceptableMin: 0.95,
                acceptableMax: 1.10,
                dayTemp: '22-26°C',
                dayRH: '55-70%',
                nightTemp: '22-23°C',
                nightRH: '60-65%',
                nightVPD: '0.90-1.10',
                color: '#27ae60'
            },
            2: {
                name: 'Semana 2',
                icon: '🌿',
                vpdRange: '0.95-1.00',
                focus: 'Desarrollo foliar',
                optimalMin: 0.95,
                optimalMax: 1.00,
                acceptableMin: 0.90,
                acceptableMax: 1.05,
                dayTemp: '20-24°C',
                dayRH: '60-70%',
                nightTemp: '21-22°C',
                nightRH: '62-66%',
                nightVPD: '0.85-1.05',
                color: '#f39c12'
            },
            3: {
                name: 'Semana 3',
                icon: '🥬',
                vpdRange: '0.80-1.00',
                focus: 'Máxima biomasa',
                optimalMin: 0.80,
                optimalMax: 1.00,
                acceptableMin: 0.75,
                acceptableMax: 1.05,
                dayTemp: '18-22°C',
                dayRH: '60-80%',
                nightTemp: '20-21°C',
                nightRH: '64-68%',
                nightVPD: '0.80-1.00',
                color: '#3498db'
            }
        };
        
        let currentWeek = 3;
        
        // Posiciones actuales de sensores
        const sensorPositions = {
            day: [
                {id: 'I1', temp: 23.6, rh: 72, vpd: 0.81},
                {id: 'I2', temp: 24.1, rh: 68, vpd: 0.96},
                {id: 'I3', temp: 24.4, rh: 63, vpd: 1.15},
                {id: 'I4', temp: 23.7, rh: 69, vpd: 0.91},
                {id: 'I5', temp: 24.1, rh: 63, vpd: 1.11},
                {id: 'I6', temp: 24.2, rh: 63, vpd: 1.13}
            ],
            night: [
                {id: 'I1', temp: 21.3, rh: 76, vpd: 0.60}, // Actual problemático
                {id: 'I2', temp: 21.8, rh: 72, vpd: 0.74}, // Actual problemático
                {id: 'I3', temp: 22.2, rh: 66, vpd: 0.92}, // Casi óptimo
                {id: 'I4', temp: 21.3, rh: 74, vpd: 0.67}, // Actual problemático
                {id: 'I5', temp: 21.9, rh: 67, vpd: 0.88}, // Casi óptimo
                {id: 'I6', temp: 21.9, rh: 68, vpd: 0.87}  // Casi óptimo
            ]
        };
        
        // Función para calcular VPD
        function calculateVPD(temp, rh) {
            const svp = 0.6108 * Math.exp((17.27 * temp) / (temp + 237.3));
            const avp = svp * (rh / 100);
            return svp - avp;
        }
        
        // Función para obtener clase CSS según VPD y semana
        function getVPDClass(vpd, week, isNight = false) {
            const config = weekConfigs[week];
            
            // Para período nocturno, usar rangos específicos
            if (isNight) {
                if (vpd >= 0.80 && vpd <= 1.10) {
                    return 'optimal';
                } else if (vpd >= 0.70 && vpd < 0.80) {
                    return 'acceptable';
                } else if (vpd < 0.70) {
                    return 'low';
                } else if (vpd > 1.10 && vpd <= 1.20) {
                    return 'high';
                } else {
                    return 'very-high';
                }
            }
            
            // Para período diurno, usar configuración por semana
            if (vpd >= config.optimalMin && vpd <= config.optimalMax) {
                return 'optimal';
            } else if (vpd >= config.acceptableMin && vpd <= config.acceptableMax) {
                return 'acceptable';
            } else if (vpd < config.acceptableMin) {
                return 'low';
            } else if (vpd > config.acceptableMax && vpd <= 1.2) {
                return 'high';
            } else {
                return 'very-high';
            }
        }
        
        // Generar tabla
        function generateTable(tableId, tempRange, rhRange, period) {
            const table = document.getElementById(tableId);
            table.innerHTML = '';
            
            // Header row
            const headerRow = document.createElement('tr');
            headerRow.innerHTML = '<th>°C \\ %HR</th>';
            
            for (let rh = rhRange.min; rh <= rhRange.max; rh += 2) {
                const th = document.createElement('th');
                th.textContent = rh + '%';
                headerRow.appendChild(th);
            }
            table.appendChild(headerRow);
            
            // Temperature rows
            for (let temp = tempRange.min; temp <= tempRange.max; temp += 0.25) {
                const row = document.createElement('tr');
                
                // Temperature cell
                const tempCell = document.createElement('td');
                tempCell.className = 'temp-col';
                tempCell.textContent = temp.toFixed(2) + '°C';
                row.appendChild(tempCell);
                
                // VPD cells
                for (let rh = rhRange.min; rh <= rhRange.max; rh += 2) {
                    const cell = document.createElement('td');
                    const vpd = calculateVPD(temp, rh);
                    cell.textContent = vpd.toFixed(2);
                    const isNight = period === 'night';
                    cell.className = 'vpd-cell ' + getVPDClass(vpd, currentWeek, isNight);
                    
                    // Color óptimo según semana o noche
                    if (cell.classList.contains('optimal')) {
                        if (isNight) {
                            cell.style.backgroundColor = '#2ecc71'; // Verde para VPD nocturno óptimo
                        } else {
                            cell.style.backgroundColor = weekConfigs[currentWeek].color;
                        }
                    } else if (cell.classList.contains('acceptable')) {
                        if (isNight) {
                            cell.style.backgroundColor = '#27ae6066'; // Verde semi-transparente
                        } else {
                            cell.style.backgroundColor = weekConfigs[currentWeek].color + '66';
                        }
                    }
                    
                    // Verificar sensores
                    const sensors = sensorPositions[period];
                    sensors.forEach(sensor => {
                        if (Math.abs(sensor.temp - temp) < 0.125 && Math.abs(sensor.rh - rh) < 1) {
                            const marker = document.createElement('div');
                            marker.className = 'sensor-marker';
                            marker.textContent = sensor.id.substring(1);
                            
                            // Marcar sensores problemáticos en período nocturno
                            if (period === 'night' && sensor.vpd < 0.80) {
                                marker.style.backgroundColor = '#e74c3c';
                                marker.style.color = 'white';
                                marker.title = `VPD actual: ${sensor.vpd} kPa - MUY BAJO`;
                            }
                            
                            cell.appendChild(marker);
                        }
                    });
                    
                    // Tooltip
                    cell.addEventListener('mouseenter', function(e) {
                        showTooltip(e, temp, rh, vpd);
                    });
                    
                    cell.addEventListener('mouseleave', hideTooltip);
                    
                    row.appendChild(cell);
                }
                
                table.appendChild(row);
            }
        }
        
        // Función para seleccionar semana
        function selectWeek(week) {
            currentWeek = week;
            
            // Actualizar botones
            document.querySelectorAll('.week-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            document.querySelector('.week-btn.week' + week).classList.add('active');
            
            // Actualizar información
            const config = weekConfigs[week];
            document.getElementById('week-icon').textContent = config.icon;
            document.getElementById('week-name').textContent = config.name;
            document.getElementById('vpd-range').textContent = config.vpdRange + ' kPa';
            document.getElementById('week-focus').textContent = config.focus;
            document.getElementById('day-temp').textContent = config.dayTemp;
            document.getElementById('day-rh').textContent = config.dayRH;
            document.getElementById('night-temp').textContent = config.nightTemp;
            document.getElementById('night-rh').textContent = config.nightRH;
            document.getElementById('night-vpd').textContent = config.nightVPD + ' kPa';
            document.getElementById('legend-week').textContent = config.name;
            
            // Regenerar tablas
            generateTable('day-table', {min: 20, max: 25}, {min: 60, max: 78}, 'day');
            generateTable('night-table', {min: 19, max: 24}, {min: 58, max: 72}, 'night');
            
            // Actualizar leyenda
            updateLegend();
        }
        
        // Actualizar leyenda
        function updateLegend() {
            const config = weekConfigs[currentWeek];
            const legendItems = document.getElementById('legend-items');
            
            legendItems.innerHTML = `
                <div class="legend-item">
                    <div class="color-box" style="background: ${config.color};"></div>
                    <span><strong>Día Óptimo:</strong> VPD ${config.vpdRange} kPa</span>
                </div>
                <div class="legend-item">
                    <div class="color-box" style="background: ${config.color}66;"></div>
                    <span>Día Aceptable</span>
                </div>
                <div class="legend-item">
                    <div class="color-box" style="background: #2ecc71;"></div>
                    <span><strong>Noche Óptimo:</strong> VPD 0.80-1.10 kPa</span>
                </div>
                <div class="legend-item">
                    <div class="color-box" style="background: #27ae6066;"></div>
                    <span>Noche Aceptable</span>
                </div>
                <div class="legend-item">
                    <div class="color-box" style="background: #f8d7da;"></div>
                    <span>VPD Bajo (< 0.80 kPa día / < 0.70 noche)</span>
                </div>
                <div class="legend-item">
                    <div class="color-box" style="background: #f5c6cb;"></div>
                    <span>VPD Alto (> ${config.acceptableMax} día / > 1.10 noche)</span>
                </div>
                <div class="legend-item">
                    <div class="color-box" style="background: white; border: 2px solid black; width: 20px; height: 20px; border-radius: 50%;"></div>
                    <span>Posición actual sensor</span>
                </div>
            `;
        }
        
        // Tooltip
        function showTooltip(e, temp, rh, vpd) {
            const tooltip = document.getElementById('tooltip');
            const rect = e.target.getBoundingClientRect();
            
            tooltip.innerHTML = `
                T: ${temp.toFixed(1)}°C<br>
                HR: ${rh}%<br>
                VPD: ${vpd.toFixed(2)} kPa
            `;
            
            tooltip.style.left = rect.left + 'px';
            tooltip.style.top = (rect.top - 50) + 'px';
            tooltip.classList.add('show');
        }
        
        function hideTooltip() {
            document.getElementById('tooltip').classList.remove('show');
        }
        
        // Inicializar
        selectWeek(3);
    </script>
</body>
</html>